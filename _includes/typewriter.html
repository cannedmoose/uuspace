<style id="styler">
</style>

<script>
	/**
	Cool typewriter effect. 
	
	.toshow tracks blocks not yet shown 
	.showing tracks current block being shown
	current character is tracked by a count data attribute

	Here's the flow:
	To start typewriting pass a selector
	Blocks have a next selector
	*/

	let typewriterElements = []
	let endersGame = new Map();
	let LAST = 0;
	function startTyping(selector, accum) {
		return;
		document.querySelectorAll(selector).forEach(el => {
			el.classList.add("cursey");
		});

		document.querySelectorAll(selector).forEach(oel => {
			let el = oel;
			let c = 0;
			while (el.nextElementSibling && !el.nextElementSibling.classList.contains("cursey")) {
				c += 1;
				el = el.nextElementSibling;
			}

			if (c > LAST) LAST = c;

			if (endersGame.has(c)) {
				endersGame.get(c).push(oel)
			} else {
				endersGame.set(c, [oel]);
 			}
		});
	}

	let lastUpdate = 0;
	let styler = document.querySelector("#styler");
	let count = 0;
	function typeWriterTick(timestamp) {
		// bow out early...
		if (timestamp < lastUpdate + 50) {
			window.requestAnimationFrame(typeWriterTick);
			return;
		}

		console.log("UPDATE", timestamp, lastUpdate);

		lastUpdate = timestamp;

		styler.innerHTML = `
		.cursey :nth-child(n + 1):nth-child(-n + ${count}) {
			opacity : 1;
		}

		.cursey :nth-child(${count + 1}){
			opacity: 1;
			background-color: white;
			fill: white;
			box-shadow: 0px 0px 2px aqua, 0px 0px 10px aqua;
			text-shadow: none;
		}
		`;
		count += 1;

	/*	let enders = endersGame.get(count);
		if (enders) {
			enders.forEach(el => {
				el.classList.remove("cursey");
				el.classList.add("visey");
			});
		}*/

		if (count <= LAST){
			window.setTimeout(() => window.requestAnimationFrame(typeWriterTick), 50);
		}
	}

	function clearBlocks(selector) {
		document.querySelectorAll(selector).forEach(el => {
			el.classList.remove("showing");
			el.classList.add("toshow");
			el.querySelectorAll(":scope .cursor").forEach(el => {
				el.classList.remove("cursor");
				el.classList.remove("blink");
			})
			el.querySelectorAll(":scope .visible").forEach(el => {
				el.classList.remove("visible");
			})
		})
	}

	function initTypeWritier(selector) {
		// Create a span for each letter.
		// Contained in a span per word.
		// TODO should have multiple ways to do this
		// eg break randomly instead of at word
		// dont break
		// etc.
		document.querySelectorAll(selector).forEach(el => {
			let text = el.innerText;
			let s = text.split(" ");
			el.setAttribute("data-text-length", text.length);
			let result = "";

			for (j = 0; j < s.length; j ++) {
				let h = ""
				for (let i = 0; i < s[j].length; i++) {
					h += `<span>${s[j].charAt(i)}</span>`
				}
				h += "<span> </span>"
				result += `<span class="cursey">${h}</span>`
				if (s[j].length > LAST) {
					LAST = s[j].length;
				}
			}

			el.innerHTML = result;
		});
	}
</script>
